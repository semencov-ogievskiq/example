(window.webpackJsonp=window.webpackJsonp||[]).push([[7,3],{343:function(t,e,n){var content=n(345);content.__esModule&&(content=content.default),"string"==typeof content&&(content=[[t.i,content,""]]),content.locals&&(t.exports=content.locals);(0,n(117).default)("7bc210c0",content,!0,{sourceMap:!1})},344:function(t,e,n){"use strict";n(343)},345:function(t,e,n){var r=n(116)(!1);r.push([t.i,".msg{width:100%;padding:.5rem;overflow:hidden}.msg-client{float:right;background-color:#e2e3e5!important}.msg-selected{background-color:#eee!important}.msg-block{max-width:46%;margin:0 2%;width:-webkit-max-content;width:-moz-max-content;width:max-content;border:1px solid #dee2e6!important;background-color:#fefefe;border-radius:1rem;padding:.5rem 1rem}.msg-header{margin-bottom:.5rem}.msg-header>a{text-decoration:none}.msg-footer{margin-top:.5rem;color:#6c757d!important;font-size:80%;font-weight:400;overflow:hidden}.msg-footer>span{float:right}",""]),t.exports=r},481:function(t,e,n){var content=n(513);content.__esModule&&(content=content.default),"string"==typeof content&&(content=[[t.i,content,""]]),content.locals&&(t.exports=content.locals);(0,n(117).default)("940a357c",content,!0,{sourceMap:!1})},484:function(t,e,n){"use strict";n.r(e);n(253);var r={props:{avatarSrc:String,f:String,i:String,o:String,body:String,dt:String,id_user:Number,client:Boolean,selected:Boolean}},o=(n(344),n(77)),component=Object(o.a)(r,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{class:"msg "+(t.selected?"msg-selected":"")},[n("div",{class:"msg-block "+(t.client?"msg-client":""),on:{dblclick:function(e){return t.$emit("select")}}},[n("div",{staticClass:"msg-header"},[n("a",{attrs:{href:"/social_network/users/"+t.id_user}},[n("b-img",t._b({attrs:{rounded:"circle","blank-color":"#777",alt:"Circle image"}},"b-img",{blank:!0,width:30,height:30},!1)),t._v(" "),n("span",[t._v(t._s(t.f)+" "+t._s(t.i))])],1)]),t._v(" "),n("div",{staticClass:"msg-body"},[n("p",[t._v(t._s(t.body))])]),t._v(" "),n("div",{staticClass:"msg-footer d-block"},[n("span",[t._v(t._s(t.dt))])])])])}),[],!1,null,null,null);e.default=component.exports},511:function(t,e,n){"use strict";var r=n(24),o=n(97).findIndex,c=n(98),d="findIndex",l=!0;d in[]&&Array(1).findIndex((function(){l=!1})),r({target:"Array",proto:!0,forced:l},{findIndex:function(t){return o(this,t,arguments.length>1?arguments[1]:void 0)}}),c(d)},512:function(t,e,n){"use strict";n(481)},513:function(t,e,n){var r=n(116)(!1);r.push([t.i,"#chat{height:100%;width:100%;min-width:25rem;max-width:60rem}.chat-body{overflow-y:scroll;overflow-x:hidden;height:70%;width:100%}",""]),t.exports=r},523:function(t,e,n){"use strict";n.r(e);var r=n(46),o=n(28),c=(n(66),n(32),n(23),n(52),n(140),n(511),n(175),{data:function(){return{form:{body:"",action:"add"},chat:{limit:20,historyEnd:!1,selected:null,list:[]}}},computed:{client:function(){return this.$auth.user},last_id:function(){return this.chat.list[0]?this.chat.list[0].id_message:null}},fetch:function(){var t=this;return Object(o.a)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(+t.$route.params.id){e.next=4;break}t.$router.replace({path:"/404"}),e.next=15;break;case 4:return t.$route.params.id,e.prev=5,e.next=8,t.getMsgs();case 8:setTimeout((function(){t.scrollMoveBottom()}),90),e.next=15;break;case 11:e.prev=11,e.t0=e.catch(5),console.log(e.t0),t.$router.replace({path:"/404"});case 15:case"end":return e.stop()}}),e,null,[[5,11]])})))()},methods:{setTypeForm:function(t){var e=this;"add"==t?(this.form.action="add",this.form.body=""):"edit"==t&&("edit"!=this.form.action?(this.form.action="edit",this.form.body=this.chat.list.find((function(t){return t.id_message==e.chat.selected})).body):this.setTypeForm("add"))},selectMessage:function(t){this.chat.list.find((function(e){return e.id_message==t})).id_user==this.client.id_user&&(this.chat.selected?this.chat.selected==t&&(this.chat.selected=null,this.setTypeForm("add")):this.chat.selected=t)},scroll:function(t){0==t.currentTarget.scrollTop&&this.getMsgs()},scrollMoveBottom:function(){var t=document.querySelector("#chat .chat-body");t.scroll(0,t.scrollHeight)},getMsgs:function(){var t=this;return Object(o.a)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.chat.historyEnd){e.next=4;break}return e.abrupt("return",!1);case 4:return e.abrupt("return",t.$axios.get(t.$root.context.env.backendUrl+"/chats/messages/"+t.$route.params.id,{params:{last_id:t.last_id,limit:t.chat.limit}}).then((function(e){var n;e.data.length>0&&(n=t.chat.list).unshift.apply(n,Object(r.a)(e.data.reverse()));(0==e.data.length||e.data.length<t.chat.limit)&&(t.chat.historyEnd=!0),document.querySelector("#chat .chat-body").scroll(0,500)})).catch((function(t){console.log(t)})));case 5:case"end":return e.stop()}}),e)})))()},sendMessage:function(){var t=this;return this.$axios.post(this.$root.context.env.backendUrl+"/chats/messages/"+this.$route.params.id,{body:this.form.body}).then((function(e){t.form.body=""})).catch((function(t){console.log(t)}))},editMessage:function(){var t=this;return this.$axios.put(this.$root.context.env.backendUrl+"/chats/messages/"+this.$route.params.id+"/"+this.chat.selected,{body:this.form.body}).then((function(e){t.selectMessage(t.chat.selected)})).catch((function(t){console.log(t)}))},deleteMessage:function(){var t=this;return this.$axios.delete(this.$root.context.env.backendUrl+"/chats/messages/"+this.$route.params.id+"/"+this.chat.selected).then((function(e){t.selectMessage(t.chat.selected)})).catch((function(t){console.log(t)}))},submitHandler:function(){"add"==this.form.action?this.sendMessage():"edit"==this.form.action&&this.editMessage()},resetHandler:function(){var t=this;"add"==this.form.action?this.form.body="":"edit"==this.form.action&&(this.form.body=this.form.body=this.chat.list.find((function(e){return e.id_message==t.chat.selected})).body)}},created:function(){var t=this;this.$root.$socket.on("sendMessage",(function(data){data.id_chat==t.$route.params.id&&data.id_message&&t.$axios.get(t.$root.context.env.backendUrl+"/chats/messages/"+t.$route.params.id+"/"+data.id_message).then((function(e){t.chat.list.push(e.data)})).catch((function(t){console.log(t)}))})),this.$root.$socket.on("editMessage",(function(data){data.id_chat==t.$route.params.id&&data.id_message&&t.$axios.get(t.$root.context.env.backendUrl+"/chats/messages/"+t.$route.params.id+"/"+data.id_message).then((function(e){var n=t.chat.list.findIndex((function(t){return t.id_message==data.id_message}));t.chat.list[n]=e.data,t.chat.list=Object(r.a)(t.chat.list)})).catch((function(t){console.log(t)}))})),this.$root.$socket.on("deleteMessage",(function(data){if(data.id_chat==t.$route.params.id&&data.id_message){var e=t.chat.list.findIndex((function(t){return t.id_message==data.id_message}));t.chat.list.splice(e,1),t.chat.list=Object(r.a)(t.chat.list)}}))}}),d=(n(512),n(77)),component=Object(d.a)(c,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{attrs:{id:"chat"}},[n("div",{staticClass:"chat-header border-bottom p-3"},[n("h4",[t._v("Название чата")]),t._v(" "),n("div",{staticStyle:{display:"flex","flex-wrap":"wrap","min-height":"2.5rem"}},[t.chat.selected?n("b-nav",{staticClass:"w-100",attrs:{pills:""}},[n("b-nav-item",{attrs:{active:"edit"==t.form.action},on:{click:function(e){return t.setTypeForm("edit")}}},[t._v("Редактировать")]),t._v(" "),n("b-nav-item",{on:{click:function(e){return t.deleteMessage()}}},[t._v("Удалить")]),t._v(" "),n("b-nav-item",{staticClass:"ml-auto",staticStyle:{"font-size":"1.7rem !important"},attrs:{"link-classes":"p-0"},on:{click:function(e){return t.selectMessage(t.chat.selected)}}},[n("b-icon-x")],1)],1):t._e()],1)]),t._v(" "),n("div",{staticClass:"chat-body",on:{scroll:t.scroll}},[t._l(t.chat.list,(function(e){return[n("Message",{key:e.id_message,attrs:{selected:t.chat.selected==e.id_message,avatarSrc:e.avatarSrc,id_user:e.id_user,f:e.f,i:e.i,body:e.body,dt:e.dt_add,client:e.id_user==t.client.id_user},on:{select:function(n){return t.selectMessage(e.id_message)}}})]}))],2),t._v(" "),n("div",{staticClass:"chat-footer p-3 border-top"},[n("form",{on:{submit:function(e){return e.preventDefault(),t.submitHandler(e)},reset:function(e){return e.preventDefault(),t.resetHandler(e)}}},[n("textarea",{directives:[{name:"model",rawName:"v-model",value:t.form.body,expression:"form.body"}],staticClass:"form-control w-100 mb-2",domProps:{value:t.form.body},on:{input:function(e){e.target.composing||t.$set(t.form,"body",e.target.value)}}}),t._v(" "),t._m(0)])])])}),[function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",[n("button",{staticClass:"btn btn-primary float-right mx-1",attrs:{type:"submit"}},[t._v("Отправить")]),t._v(" "),n("button",{staticClass:"btn btn-secondary float-right mx-1",attrs:{type:"reset"}},[t._v("Очистить")])])}],!1,null,null,null);e.default=component.exports;installComponents(component,{Message:n(484).default})}}]);